# =============================================================================
# MHTI è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒå·¥ä½œæµ
# =============================================================================
# è§¦å‘æ¡ä»¶ï¼š
#   - æ¨é€å¸¦æœ‰ v* æ ¼å¼çš„æ ‡ç­¾ (å¦‚ v1.0.0)
#   - æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
#
# åŠŸèƒ½ï¼š
#   1. æ„å»º Docker å¤šæ¶æ„é•œåƒ (Dockerfile å†…éƒ¨æ„å»ºå‰ç«¯)
#   2. æ¨é€åˆ° Docker Hub
#   3. å¯¼å‡ºé•œåƒæ–‡ä»¶åˆ° Releases
#   4. åˆ›å»º GitHub Release
# =============================================================================

name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (å¦‚ 1.0.0ï¼Œä¸å¸¦ v å‰ç¼€)'
        required: true
        default: '1.0.0'
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

env:
  DOCKER_IMAGE: xiyan520/mhti
  REGISTRY: docker.io

jobs:
  # ===========================================================================
  # å‡†å¤‡é˜¶æ®µï¼šç¡®å®šç‰ˆæœ¬å·
  # ===========================================================================
  prepare:
    name: ğŸ“‹ å‡†å¤‡ç‰ˆæœ¬ä¿¡æ¯
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: ç¡®å®šç‰ˆæœ¬å·
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
            IS_PRERELEASE="false"
            if [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]] || [[ "$VERSION" == *"rc"* ]]; then
              IS_PRERELEASE="true"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION"
          echo "ğŸ·ï¸ æ ‡ç­¾: v$VERSION"
          echo "ğŸš€ é¢„å‘å¸ƒ: $IS_PRERELEASE"

  # ===========================================================================
  # æ„å»ºå¹¶æ¨é€ Docker é•œåƒåˆ° Docker Hub
  # ===========================================================================
  build-and-push:
    name: ğŸ³ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® QEMU (å¤šæ¶æ„æ”¯æŒ)
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: æå– Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.prepare.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.prepare.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.prepare.outputs.version }}
            type=raw,value=latest,enable=${{ needs.prepare.outputs.is_prerelease == 'false' }}

      - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        id: build-push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false

      - name: è¾“å‡ºæ¨é€ç»“æœ
        run: |
          echo "## ğŸ³ Docker é•œåƒæ¨é€æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒæ ‡ç­¾:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build-push.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # å¯¼å‡º Docker é•œåƒæ–‡ä»¶ (ç”¨äºç¦»çº¿éƒ¨ç½²)
  # ===========================================================================
  export-images:
    name: ğŸ“¦ å¯¼å‡ºé•œåƒ (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: [prepare, build-and-push]
    strategy:
      matrix:
        include:
          - arch: amd64
            platform: linux/amd64
          - arch: arm64
            platform: linux/arm64
    steps:
      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      - name: æ‹‰å–é•œåƒ
        run: |
          docker pull --platform ${{ matrix.platform }} ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}
          echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ"

      - name: å¯¼å‡ºé•œåƒä¸º tar.gz
        run: |
          FILENAME="mhti-${{ needs.prepare.outputs.version }}-${{ matrix.arch }}.tar.gz"
          docker save ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }} | gzip > $FILENAME
          ls -lh $FILENAME
          echo "âœ… é•œåƒå¯¼å‡ºæˆåŠŸ: $FILENAME"

      - name: ä¸Šä¼ é•œåƒæ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ matrix.arch }}
          path: mhti-${{ needs.prepare.outputs.version }}-${{ matrix.arch }}.tar.gz
          retention-days: 3
          compression-level: 0

  # ===========================================================================
  # æ„å»ºå‰ç«¯ ZIP åŒ…
  # ===========================================================================
  build-frontend-zip:
    name: ğŸ¨ æ‰“åŒ…å‰ç«¯
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: å®‰è£…ä¾èµ–å¹¶æ„å»º
        working-directory: web
        run: |
          npm ci
          npm run build

      - name: æ‰“åŒ…å‰ç«¯
        run: |
          cd web
          zip -r ../mhti-frontend-${{ needs.prepare.outputs.version }}.zip dist/
          ls -lh ../mhti-frontend-*.zip

      - name: ä¸Šä¼ å‰ç«¯åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: frontend-zip
          path: mhti-frontend-${{ needs.prepare.outputs.version }}.zip
          retention-days: 3

  # ===========================================================================
  # åˆ›å»º GitHub Release
  # ===========================================================================
  create-release:
    name: ğŸš€ åˆ›å»º Release
    runs-on: ubuntu-latest
    needs: [prepare, build-and-push, export-images, build-frontend-zip]
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä¸‹è½½ Docker é•œåƒ (amd64)
        uses: actions/download-artifact@v4
        with:
          name: docker-image-amd64
          path: artifacts/docker-image-amd64

      - name: ä¸‹è½½ Docker é•œåƒ (arm64)
        uses: actions/download-artifact@v4
        with:
          name: docker-image-arm64
          path: artifacts/docker-image-arm64

      - name: ä¸‹è½½å‰ç«¯åŒ…
        uses: actions/download-artifact@v4
        with:
          name: frontend-zip
          path: artifacts/frontend-zip

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files

          # ç§»åŠ¨ Docker é•œåƒ
          find artifacts -name "*.tar.gz" -exec mv {} release-files/ \;

          # ç§»åŠ¨å‰ç«¯ ZIP
          find artifacts -name "*.zip" -exec mv {} release-files/ \;

          # åˆ›å»ºæºç åŒ…
          git archive --format=zip --prefix=mhti-${{ needs.prepare.outputs.version }}/ \
            -o release-files/mhti-source-${{ needs.prepare.outputs.version }}.zip HEAD

          # ç”Ÿæˆæ ¡éªŒå’Œ
          cd release-files
          sha256sum * > SHA256SUMS.txt

          echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶:"
          ls -lh

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges ${PREVIOUS_TAG}..HEAD)
          fi

          # å¦‚æœæ²¡æœ‰æäº¤è®°å½•ï¼Œæ˜¾ç¤ºé»˜è®¤ä¿¡æ¯
          if [ -z "$COMMITS" ]; then
            COMMITS="- é¦–æ¬¡å‘å¸ƒ"
          fi

          {
            echo "changelog<<EOF"
            echo "$COMMITS"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: MHTI ${{ needs.prepare.outputs.tag }}
          body: |
            ## ğŸ‰ MHTI ${{ needs.prepare.outputs.tag }}

            **åª’ä½“æ–‡ä»¶åˆ®å‰Šä¸æ•´ç†å·¥å…·** - è‡ªåŠ¨ä» TMDB è·å–å…ƒæ•°æ®

            ---

            ### ğŸ³ Docker éƒ¨ç½²

            #### æ–¹å¼ä¸€ï¼šä» Docker Hub æ‹‰å–ï¼ˆæ¨èï¼‰

            ```bash
            # æ‹‰å–æœ€æ–°ç‰ˆæœ¬
            docker pull ${{ env.DOCKER_IMAGE }}:latest

            # æ‹‰å–æŒ‡å®šç‰ˆæœ¬
            docker pull ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}

            # è¿è¡Œå®¹å™¨
            docker run -d \
              --name mhti \
              -p 8000:8000 \
              -v ./data:/app/data \
              -v /path/to/media:/media:ro \
              -e TZ=Asia/Shanghai \
              ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}
            ```

            #### æ–¹å¼äºŒï¼šä» Release åŠ è½½é•œåƒï¼ˆç¦»çº¿éƒ¨ç½²ï¼‰

            ```bash
            # AMD64 æ¶æ„ (Intel/AMD å¤„ç†å™¨)
            gunzip -c mhti-${{ needs.prepare.outputs.version }}-amd64.tar.gz | docker load

            # ARM64 æ¶æ„ (Apple Silicon/æ ‘è“æ´¾)
            gunzip -c mhti-${{ needs.prepare.outputs.version }}-arm64.tar.gz | docker load

            # ç„¶åè¿è¡Œ
            docker run -d --name mhti -p 8000:8000 ${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}
            ```

            ---

            ### ğŸ“‹ æ›´æ–°æ—¥å¿—

            ${{ steps.changelog.outputs.changelog }}

            ---

            ### ğŸ“¦ ä¸‹è½½è¯´æ˜

            | æ–‡ä»¶ | è¯´æ˜ | å¤§å° |
            |------|------|------|
            | `mhti-*-amd64.tar.gz` | Docker é•œåƒ (x86_64) | ~200MB |
            | `mhti-*-arm64.tar.gz` | Docker é•œåƒ (ARM64) | ~200MB |
            | `mhti-frontend-*.zip` | å‰ç«¯æ„å»ºäº§ç‰© | ~2MB |
            | `mhti-source-*.zip` | æºä»£ç  | ~1MB |
            | `SHA256SUMS.txt` | æ ¡éªŒå’Œ | - |

            ---

            ### ğŸ”— é“¾æ¥

            - ğŸ“– [ä½¿ç”¨æ–‡æ¡£](https://github.com/${{ github.repository }}/blob/main/README.md)
            - ğŸ³ [Docker Hub](https://hub.docker.com/r/${{ env.DOCKER_IMAGE }})
            - ğŸ› [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)

          files: release-files/*
          draft: false
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒæ‘˜è¦
        run: |
          echo "## âœ… å‘å¸ƒæˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | ${{ needs.prepare.outputs.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker é•œåƒ | \`${{ env.DOCKER_IMAGE }}:${{ needs.prepare.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | [æŸ¥çœ‹](https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag }}) |" >> $GITHUB_STEP_SUMMARY
