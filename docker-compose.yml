# MHTI Docker Compose Configuration
# =====================================
# Architecture: Caddy (reverse proxy) + FastAPI (API)
#   - Port 8000: Main entry (Caddy - frontend + API unified)
#
# Usage:
#   docker-compose up -d        # Start
#   docker-compose logs -f      # View logs
#   docker-compose down         # Stop

services:
  mhti:
    # 稳定版（每次打 v*.*.* 标签时更新）：
    # image: xiyan520/mhti:latest
    # 最新开发版（每次 push 到 main 分支时自动更新，需先登录 GHCR）：
    image: ghcr.io/xiyan520/mhti:main
    pull_policy: always   # docker compose up 时自动拉取最新镜像
    container_name: mhti
    restart: unless-stopped

    ports:
      - "8000:8000"   # Main entry (Caddy - frontend + API)

    volumes:
      - ./data:/app/data
      - ./Caddyfile:/etc/caddy/Caddyfile:ro  # 挂载本地 Caddyfile
      # Media library mount points
      # - /path/to/your/media:/media:ro
      # - /path/to/your/output:/output

    environment:
      - DATA_DIR=/app/data
      - TZ=Asia/Shanghai

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
